<table>
  <tbody>
    <tr>
      <th><%= l(:label_imap_host) %></th>
      <td>
        <%= text_field_tag 'settings[imap_host]', @settings['imap_host'], size: 60 %>
      </td>
    </tr>
    <tr>
      <th><%= l(:label_imap_port) %></th>
      <td>
        <%= text_field_tag 'settings[imap_port]', @settings['imap_port'], size: 10 %>
      </td>
    </tr>
    <tr>
      <th><%= l(:label_imap_ssl) %></th>
      <td>
        <%= check_box_tag 'settings[imap_ssl]', '1', @settings['imap_ssl'] == '1' %>
      </td>
    </tr>
    <tr>
      <th><%= l(:label_imap_username) %></th>
      <td>
        <%= text_field_tag 'settings[imap_username]', @settings['imap_username'], size: 60 %>
      </td>
    </tr>
    <tr>
      <th><%= l(:label_imap_password) %></th>
      <td>
        <%= password_field_tag 'settings[imap_password]', @settings['imap_password'], size: 60 %>
      </td>
    </tr>
    <tr>
      <th><%= l(:label_imap_folder) %></th>
      <td>
        <%= text_field_tag 'settings[imap_folder]', @settings['imap_folder'], size: 30 %>
      </td>
    </tr>
    <tr>
      <th><%= l(:label_default_project) %></th>
      <td>
        <%= select_tag 'settings[default_project]',
            options_from_collection_for_select(Project.active.sorted, 'identifier', 'name', @settings['default_project']) %>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <%= button_tag l(:button_test_connection), type: 'button', id: 'test-connection-button', class: 'button' %>
        <span id="test-connection-result"></span>
      </td>
    </tr>
  </tbody>
</table>

<%= javascript_tag do %>
  $(document).ready(function() {
    $('#test-connection-button').click(function() {
      var button = $(this);
      var resultSpan = $('#test-connection-result');
      
      button.prop('disabled', true);
      resultSpan.html('<em><%= l(:text_testing_connection) %>...</em>');
      
      $.ajax({
        url: '<%= url_for(controller: 'email_receiver', action: 'test_connection') %>',
        method: 'POST',
        success: function(response) {
          if (response.status === 'success') {
            resultSpan.html('<span class="notice">' + response.message + '</span>');
          } else {
            resultSpan.html('<span class="error">' + response.message + '</span>');
          }
        },
        error: function() {
          resultSpan.html('<span class="error"><%= l(:error_test_connection_failed) %></span>');
        },
        complete: function() {
          button.prop('disabled', false);
        }
      });
    });
  });
<% end %>